<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Karaoké</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #queue-section { max-width: 600px; margin: auto; }
        #queue-list div { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .queue-name { font-weight: bold; }
        .delete-btn { background: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="queue-section">
        <h2>File d'attente</h2>
        <div id="queue-list"></div>
    </div>

    <script>
        const queueListEl = document.getElementById('queue-list');

        async function loadQueue() {
            try {
                const response = await fetch('/api/queue'); 
                const queueData = await response.json(); // Ceci est l'array de strings brutes

                // Transformer la liste brute en liste "UI"
                // sans planter sur les données corrompues
                const queueForUi = queueData.map(item => {
					// si déjà objet → nickel
					if (typeof item === "object") {
						return { ...item, isRaw: false };
					}

					// si string → tenter de parse
					try {
						return { ...JSON.parse(item), isRaw: false };
					} catch {
						// sinon → donnée brute
						return {
							name: "⚠️ DONNÉE BRUTE ⚠️",
							songTitle: item,
							id: null,
							isRaw: true,
							rawValue: item
						};
					}
				});

                
                renderQueue(queueForUi); // On envoie la liste "nettoyée"

            } catch (e) {
                queueListEl.innerHTML = "Erreur de chargement de la file.";
                console.error(e);
            }
        }

        function renderQueue(queue) {
            queueListEl.innerHTML = '';
            if (queue.length === 0) {
                queueListEl.innerHTML = "<p>File d'attente vide.</p>";
                return;
            }
            
            queue.forEach((item, index) => {
                const div = document.createElement('div');
                let deleteButtonHtml = '';

                if (item.isRaw) {
                    // BOUTON SUPPRIMER pour DONNÉE BRUTE
                    // On envoie la valeur brute, encodée pour l'URL
                    const safeValue = encodeURIComponent(item.rawValue);
                    deleteButtonHtml = `<button class="delete-btn" data-id="${safeValue}">Supprimer</button>`;
                } else {
                    // BOUTON SUPPRIMER pour DONNÉE JSON
                    // On envoie l'ID
                    deleteButtonHtml = `<button class="delete-btn" data-id="${item.id}">Supprimer</button>`;
                }
                
                div.innerHTML = `
                    <span>
                        <span class="queue-name">${index + 1}. ${item.name}</span><br>
                        <span>${item.songTitle}</span>
                    </span>
                    ${deleteButtonHtml}
                `;
                queueListEl.appendChild(div);
            });

            // Attacher UN SEUL type d'écouteur
            document.querySelectorAll('.delete-btn').forEach(btn => {
                // On passe l'ID (qui est soit un nombre, soit une chaîne encodée)
                btn.onclick = () => deleteFromQueue(btn.dataset.id);
            });
        }

        async function deleteFromQueue(id) {
			if (!confirm("Supprimer cette entrée ?")) return;

			const res = await fetch('/api/queue', {
				method: 'DELETE',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ id })
			});

			const data = await res.json();

			if (!res.ok) {
				alert("Erreur : " + data.message);
				return;
			}

			loadQueue(); // rafraîchir
		}

        // --- Init ---
        loadQueue();
        setInterval(loadQueue, 5000); // Rafraîchit la file
    </script>
</body>
</html>